# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## User Preferences

- **Language**: Always communicate with the user in Spanish (Español). All responses, explanations, and questions must be in Spanish.

## Repository Context

This is a fork of [AymanLyesri/ArchEclipse](https://github.com/AymanLyesri/ArchEclipse), a comprehensive Hyprland rice configuration for Arch Linux. The fork adds extensive multi-monitor support, workspace state preservation for KVM switches, and clipboard management enhancements.

**Your Fork:** [mrvictor22/ArchEclipse](https://github.com/mrvictor22/ArchEclipse)

## Configuration Architecture

### Core Structure

- **`hyprland.conf`**: Main entry point that sources all configuration files
  - Sources `configs/*` for base configuration
  - Sources `configs/custom/*` for user overrides
  - Sources `configs/plugins/*` for plugin settings

### Configuration Layers

1. **Base configs** (`configs/*.conf`): Default settings that can be overridden
2. **Custom configs** (`configs/custom/*.conf`): User-specific overrides (take precedence)
3. **Generated configs**: Auto-generated by scripts (e.g., `monitors.conf`)

This layered approach allows pulling upstream updates while preserving local customizations.

### Key Configuration Files

- `configs/exec.conf`: Startup commands and autostart applications
- `configs/keybinds.conf`: Primary keyboard shortcuts
- `configs/multi-monitor-keybinds.conf`: Multi-monitor specific keybinds
- `configs/monitors.conf`: Auto-generated monitor configuration
- `configs/general.conf`: Core Hyprland settings (layout, input, gestures, decorations)

## Multi-Monitor System

### Core Scripts

**`scripts/multi-monitor-manager.sh`**: Central multi-monitor management
- Commands: `auto`, `status`, `redistribute`, `setup`, `lid`
- Auto-detects laptop vs desktop hardware
- Handles monitor configuration and workspace distribution

**`scripts/monitor-hotplug.sh`**: Automatic monitor hotplug detection
- Runs as systemd service (`hyprland-monitor-hotplug.service`)
- Monitors for connect/disconnect events every 2 seconds
- Automatically triggers: monitor reconfiguration, AGS restart, hyperpaper reload
- Commands: `monitor` (daemon), `restart-ags`, `reload-hyperpaper`, `reload-all`, `check`

**`scripts/lid-handler.sh`**: Laptop lid event handler
- Runs as systemd service (`hyprland-lid-handler.service`)
- Smart behavior: disables internal monitor when lid closed with AC + external monitor
- Moves workspaces to external monitor automatically

**`scripts/monitor-setup.sh`**: Quick setup presets
- Options: `auto`, `laptop-only`, `external-only`, `dual-extend`, `dual-mirror`

### Multi-Monitor Flow

1. User connects/disconnects monitor
2. `monitor-hotplug.sh` detects change (2s polling)
3. Executes `multi-monitor-manager.sh auto` (reconfigures monitors)
4. Waits 1s for stabilization
5. Restarts AGS bars with `--gtk 3` flag (required for AGS 3.0+)
6. Reloads hyperpaper wallpapers

### Important: AGS 3.0 Compatibility

AGS was upgraded to version 3.0.0, which requires explicit GTK version specification and proper library loading order.

**Required environment variables for AGS:**

```bash
LD_PRELOAD=/usr/lib/libgtk4-layer-shell.so GDK_BACKEND=wayland ags run --gtk 3 --log-file /tmp/ags.log
```

**Why LD_PRELOAD is required:**
- gtk4-layer-shell uses a shim to intercept libwayland calls
- If libwayland loads before gtk4-layer-shell, the shim doesn't work
- This causes `gtk_layer_is_supported()` to return `false` and bars won't appear
- LD_PRELOAD forces gtk4-layer-shell to load first, ensuring proper layer shell support

**Symptoms of missing LD_PRELOAD:**
- Bars don't appear on any monitor
- Log shows: `layer shell not supported`
- Log shows: `GtkWindow is not a layer surface`
- `gtk_layer_is_supported()` returns `false` even though Hyprland supports layer shell

This applies to:
- `configs/exec.conf` (startup)
- `scripts/monitor-hotplug.sh` (automatic restart)
- `scripts/multi-monitor-manager.sh` (manual restart)
- `scripts/bar.sh` (bar management)
- `scripts/validate-bar.sh` (bar validation)

## Workspace State Preservation (KVM Support)

### Purpose
Preserves window positions across monitor changes when switching between machines via KVM.

### Key Script

**`scripts/workspace-state-manager.sh`**: Saves and restores workspace state
- Commands: `save`, `restore`, `show`, `current`, `clear`, `auto-restore`
- State stored in: `~/.cache/hypr/workspace-states/current-state.json`
- Backups: Last 5 states preserved automatically
- Logs: `/tmp/hyprland-workspace-state.log`

### Automatic Operation

Integrated into `monitor-hotplug.sh`:
1. **On disconnect**: Saves current window positions and workspaces
2. **On reconnect**: Waits for monitor stabilization, then restores (if state < 10 minutes old)

Window identification uses: class, initialClass, title, and PID for robust matching.

## Clipboard Monitor System

### Architecture

**`scripts/start-clipboard-monitor.sh`**: Singleton launcher with multi-layer protection
- Uses atomic locking (`/tmp/clipboard-monitor.lock.d/`)
- PID file validation (`/tmp/clipboard-monitor.pid`)
- Prevents duplicate notification instances

**`scripts/clipboard-monitor.sh`**: Core notification logic
- Triggered by `wl-paste --watch`
- Shows notifications for text/image copies
- Activity log: `/tmp/clip-count.log`

**`scripts/check-clipboard-monitor.sh`**: Health check and diagnostics

### Important: Single Instance Only

The clipboard monitor MUST run as a singleton. Multiple instances cause duplicate notifications. The system has 5-layer protection:
1. Process detection
2. Atomic locking
3. PID validation
4. Race condition prevention
5. Aggressive cleanup of unmanaged processes

Always use `start-clipboard-monitor.sh` to launch - never call `clipboard-monitor.sh` directly.

## Screenshot System for Claude Code

### Problem Solved

Due to Wayland clipboard limitations, Claude Code cannot reliably read images from the clipboard using Ctrl+V. The system now saves screenshots with a predictable filename for easy access.

### How It Works

When you take a screenshot with `hyprshot`:
1. Image saved with timestamp: `~/Pictures/Screenshots/TIMESTAMP_hyprshot.png`
2. **Also saved as**: `~/Pictures/Screenshots/latest.png` (always points to most recent)
3. Copied to clipboard (for notifications and other apps)
4. Clipboard monitor detects and saves to `/tmp/clipboard_image_*.png`

### Using Screenshots with Claude Code

**Method 1: Direct Path (Recommended)**
```
User: "Read ~/Pictures/Screenshots/latest.png"
```

**Method 2: Helper Script**
```bash
~/.config/hypr/scripts/show-latest-screenshot.sh
# Shows info and copies path to clipboard
```

**Method 3: Manual Path**
If you need a specific screenshot, list them:
```bash
ls -lth ~/Pictures/Screenshots/*.png | head -5
```
Then tell Claude Code to read the specific file.

### Workflow

1. Take screenshot with your keybind (e.g., `Super + Print`)
2. In Claude Code chat, type: `Read ~/Pictures/Screenshots/latest.png`
3. Claude Code will display and analyze the image

**Note**: The `latest.png` file is overwritten with each new screenshot, so reference it immediately after capturing.

## Syncing with Upstream

### Current Fork Status (Updated 2026-01-04)

✅ **Historial limpio y lineal** - El fork ahora tiene un historial limpio basado en upstream/master.

| Métrica | Estado |
|---------|--------|
| Commits detrás de upstream | 0 |
| Commits adelante de upstream | 2 (mejoras del fork) |
| Historial | Lineal (no divergente) |

### Simple Sync Procedure (NUEVO - Post Rebase 2026-01-04)

Ahora que el historial está limpio, sincronizar es simple:

```bash
# 1. Fetch upstream
git fetch upstream

# 2. Ver qué commits hay nuevos
git log --oneline HEAD..upstream/master

# 3. Si hay commits nuevos, hacer merge (debería ser fast-forward o limpio)
git merge upstream/master

# 4. Verificar que AGS compila
cd ~/.config/ags && ags bundle app.ts /tmp/test.js

# 5. Push a tu fork
git push origin master
```

**Si hay conflictos:**
```bash
# Resolver conflictos manualmente
git status  # Ver archivos en conflicto
# Editar archivos, resolver conflictos
git add <archivos-resueltos>
git commit -m "merge: resolve conflicts with upstream"
```

### Verificar Estado de Sincronización

```bash
# Ver cuántos commits estás detrás/adelante
git fetch upstream
git rev-list --count HEAD..upstream/master  # Detrás
git rev-list --count upstream/master..HEAD  # Adelante

# Ver commits pendientes de upstream
git log --oneline HEAD..upstream/master
```

### Upstream Integration Procedure (via Claude Code)

**IMPORTANT:** Si Claude Code hace integraciones, debe seguir este procedimiento:

1. **Verificar estado** antes de empezar:
   ```bash
   git fetch upstream
   git log --oneline HEAD..upstream/master
   ```

2. **Si hay pocos commits** (< 10): Merge directo
   ```bash
   git merge upstream/master
   ```

3. **Si hay muchos commits** o conflictos potenciales: Crear rama de integración
   ```
   integration/upstream-sync-YYYYMMDD
   ```

4. **Verificar AGS compilation** después del merge

5. **NEVER include in commits:**
   - `Co-Authored-By: Claude`
   - `Generated with [Claude Code]`
   - Any AI attribution markers

### Contributing Fixes to Upstream

When you find and fix a bug that also affects upstream, follow this procedure to create a clean PR:

**Why this is needed:** Our fork's git history diverged from upstream (due to commit rewrites), so we can't create PRs directly from our master branch. We must create a fresh branch from `upstream/master`.

**Procedure:**

1. **Create issue first** (documents the problem):
   ```bash
   gh issue create --repo AymanLyesri/ArchEclipse \
     --title "[Bug] Brief description" \
     --body "Description, root cause, proposed fix"
   ```

2. **Stash local changes** (if any):
   ```bash
   git stash
   ```

3. **Create branch from upstream/master**:
   ```bash
   git fetch upstream
   git checkout -b fix/descriptive-name upstream/master
   ```

4. **Apply the fix** (same changes you made locally)

5. **Commit with clean message** (reference the issue):
   ```bash
   git commit -m "fix: brief description

   Detailed explanation of the problem and solution.

   Fixes #ISSUE_NUMBER"
   ```

6. **Push to your fork**:
   ```bash
   git push -u origin fix/descriptive-name
   ```

7. **Create PR to upstream**:
   ```bash
   gh pr create --repo AymanLyesri/ArchEclipse \
     --base master \
     --head mrvictor22:fix/descriptive-name \
     --title "fix: brief description" \
     --body "Summary, changes, test plan. Fixes #ISSUE_NUMBER"
   ```

8. **Return to master and restore stash**:
   ```bash
   git checkout master
   git stash pop
   ```

**Branch naming convention for fixes:**
- `fix/hyprpaper-memory-leak` - bug fixes
- `feat/new-feature-name` - new features
- `docs/update-readme` - documentation

**Example PRs created this way:**
- #189: Hyprpaper memory leak fix

### Manual Commands

```bash
# Check for new upstream commits
git fetch upstream && git log --oneline HEAD..upstream/master

# View upstream changes
git diff master..upstream/master --stat
```

### Update Script

The `UPDATE.sh` script handles **only system package updates** across multiple package managers. It does NOT sync with upstream git repositories - that should be done manually via Claude Code or git commands.

```bash
# Interactive mode (default) - prompts for each action
./maintenance/UPDATE.sh

# Update everything without prompts
./maintenance/UPDATE.sh --all

# Quick daily update (AUR + flatpak only)
./maintenance/UPDATE.sh --quick

# Specific package managers only
./maintenance/UPDATE.sh --aur       # AUR packages (yay/paru)
./maintenance/UPDATE.sh --flatpak   # Flatpak packages
./maintenance/UPDATE.sh --snap      # Snap packages
./maintenance/UPDATE.sh --pip       # Python packages (pipx/pip)

# Maintenance operations
./maintenance/UPDATE.sh --rice      # Rice maintenance (wallpapers, wal, plugins)
./maintenance/UPDATE.sh --clean     # Clean system caches
./maintenance/UPDATE.sh --services  # Verify Hyprland services

# Show help
./maintenance/UPDATE.sh --help
```

**Supported Package Managers:**
- pacman/yay/paru (Arch Linux AUR)
- flatpak
- snap
- pip/pipx (Python)

**Additional Features:**
- System cache cleanup (pacman cache, journal logs, thumbnails)
- Hyprland services verification (monitor-hotplug, lid-handler, AGS, clipboard)
- Rice maintenance scripts (wallpapers, pywal, plugins, tweaks)
- Summary report at the end

**Note:** For syncing with upstream Ayman's repository, use manual git commands or Claude Code to review changes before merging.

## Development Commands

### Monitor Management

```bash
# Auto-configure monitors
~/.config/hypr/scripts/multi-monitor-manager.sh auto

# Show current status
~/.config/hypr/scripts/multi-monitor-manager.sh status

# Check hotplug daemon logs
tail -f /tmp/hyprland-monitor-hotplug.log

# Manually restart AGS and hyperpaper
~/.config/hypr/scripts/monitor-hotplug.sh reload-all
```

### Workspace State

```bash
# Save current state
~/.config/hypr/scripts/workspace-state-manager.sh save

# Restore previous state
~/.config/hypr/scripts/workspace-state-manager.sh restore

# View saved state
~/.config/hypr/scripts/workspace-state-manager.sh show

# View current state
~/.config/hypr/scripts/workspace-state-manager.sh current

# View logs
tail -f /tmp/hyprland-workspace-state.log
```

### Clipboard Monitor

```bash
# Start/restart monitor (handles singleton protection)
~/.config/hypr/scripts/start-clipboard-monitor.sh

# Check health status
~/.config/hypr/scripts/check-clipboard-monitor.sh

# Emergency stop (if duplicates occur)
pkill -9 -f "wl-paste.*clipboard"
~/.config/hypr/scripts/start-clipboard-monitor.sh

# View logs
tail -f /tmp/clipboard-monitor-startup.log
tail -f /tmp/clip-count.log
```

### Systemd Services

```bash
# Monitor hotplug service
systemctl --user status hyprland-monitor-hotplug.service
systemctl --user restart hyprland-monitor-hotplug.service
journalctl --user -u hyprland-monitor-hotplug.service -f

# Lid handler service
systemctl --user status hyprland-lid-handler.service
systemctl --user restart hyprland-lid-handler.service
```

### Hyprland Commands

```bash
# View current monitors
hyprctl monitors

# View monitor details (JSON)
hyprctl monitors -j

# View all windows
hyprctl clients

# Reload Hyprland configuration
hyprctl reload
```

## Key Implementation Details

### Script Location Variables

Most scripts use these standard variables:
- `$scriptsDir`: `$HOME/.config/hypr/scripts`
- `$hyprDir`: `$HOME/.config/hypr`
- `$themeScriptsDir`: `$HOME/.config/hypr/theme/scripts`

### Critical Files to Preserve

When syncing with upstream, protect these user-specific files:
- `configs/custom/*`: All user customizations
- `configs/monitors.conf`: Auto-generated, but user-specific
- `.gitignore`: Protects local files

### Dependencies

- `jq`: Required for JSON parsing in all monitor/workspace scripts
- `hyprctl`: Hyprland IPC for querying/controlling the compositor
- `wl-paste`: Clipboard monitoring
- `ags` (Astal GTK Scaffolding): Status bar system (requires v3.0+ with `--gtk 3`)
- `hyperpaper`: Wallpaper daemon
- `notify-send`: Desktop notifications

### Known Issues

1. **AGS 3.0 Migration**: Always include `--gtk 3` flag when launching AGS
2. **Workspace State Restoration**: Only works for apps with stable class names (some apps change their class dynamically)
3. **Monitor Hotplug Timing**: 2-second polling interval may miss very rapid connect/disconnect
4. **Clipboard Duplicates**: If occurring, check for multiple `wl-paste` processes and use `check-clipboard-monitor.sh`

### Bugs Fixed (Fork)

This section documents bugs found and fixed in this fork that may exist in upstream.

#### 1. Hyprpaper Memory Leak (Fixed: 2025-01-02)

**Problem:** Each wallpaper change or monitor hotplug event spawned a new `hyprpaper` instance without killing the previous one. This caused:
- Massive VRAM consumption (observed: 15 instances using 3.87 GiB of 4 GiB VRAM)
- System slowdown due to GPU memory exhaustion
- Accumulated zombie processes over time

**Root Cause:**
- `hyprpaper/load.sh` started `hyprpaper &` without killing existing instances
- `hyprpaper/reload.sh` only killed `auto.sh`, not `hyprpaper`

**Files Fixed:**
- `hyprpaper/load.sh`: Added `killall hyprpaper` before starting new instance
- `hyprpaper/reload.sh`: Added `killall hyprpaper` alongside `killall auto.sh`

**Detection:** Run `pgrep -c hyprpaper` - should return `1`. If more, run:
```bash
pkill -9 hyprpaper && ~/.config/hypr/hyprpaper/reload.sh
```

**VRAM Monitoring:**
```bash
# Check VRAM usage (AMD GPU)
cat /sys/class/drm/card1/device/mem_info_vram_used | awk '{printf "%.2f GiB\n", $1/1024/1024/1024}'

# Check total VRAM
cat /sys/class/drm/card1/device/mem_info_vram_total | awk '{printf "%.2f GiB\n", $1/1024/1024/1024}'
```

#### 2. AGS Multi-Monitor Bar Not Appearing (Fixed: 2026-01-04)

**Problem:** When multiple monitors are connected, AGS only creates bars for the first monitor. The second monitor has no bar even though AGS detects both monitors.

**Symptoms:**
- `hyprctl layers` shows bar only on first monitor (eDP-1)
- AGS log shows "TOTAL MONITORS DETECTED: 2" but only processes first monitor
- Second monitor (DP-3) has no bar layer surface

**Root Causes (3 issues):**

1. **`getMonitorName()` returning undefined for second monitor:**
   - Original code used `monitor.get_model()` + complex hyprctl matching
   - GTK4's `Gdk.Monitor.get_connector()` directly returns connector name (eDP-1, DP-3)
   - Fix: Use `get_connector()` as primary method with fallback to old method

2. **Errors in first monitor blocking second monitor:**
   - Original code used `.map()` without error handling
   - Notification widget errors (`notificationIcon is null`) caused exception
   - Exception stopped iteration before processing second monitor
   - Fix: Use `.forEach()` with try-catch wrapper

3. **No support for monitor hotplug:**
   - Original code only called `perMonitorDisplay()` once at startup
   - Monitors connected after AGS start never got widgets
   - Fix: Listen to `notify::monitors` signal and create widgets for new monitors

**Files Fixed:**
- `.config/ags/app.ts`: Added GLib import, monitor tracking Set, error handling, hotplug detection
- `.config/ags/utils/monitor.ts`: Use `get_connector()` as primary method

**Code Changes in `app.ts`:**
```typescript
// Track initialized monitors to avoid duplicates
const initializedMonitors = new Set<string>();

// Process each monitor with error handling
monitors.forEach((monitor) => {
  try {
    createWidgetsForMonitor(monitor);
  } catch (e) {
    print("\t ERROR creating widgets for monitor: " + monitor.get_connector() + " - " + e);
  }
});

// Setup hotplug detection
app.connect("notify::monitors", () => {
  GLib.idle_add(GLib.PRIORITY_DEFAULT, () => {
    monitors.forEach((monitor) => createWidgetsForMonitor(monitor));
    return GLib.SOURCE_REMOVE;
  });
});
```

**Code Changes in `utils/monitor.ts`:**
```typescript
export function getMonitorName(display: Gdk.Display, monitor: Gdk.Monitor) {
  // GTK4 provides get_connector() which returns Wayland connector name directly
  const connector = monitor.get_connector();
  if (connector) return connector;

  // Fallback to old method
  const model = monitor.get_model() || monitor.get_description();
  return getConnectorFromHyprland(model as any);
}
```

**Verification:**
```bash
# Check bars on all monitors
hyprctl layers | grep -E "Monitor|bar"

# Should show bar layer for each monitor:
# Monitor eDP-1:
#     Layer ...: namespace: bar
# Monitor DP-3:
#     Layer ...: namespace: bar
```

## Architecture Patterns

### Configuration Sourcing Order

1. `hyprland.conf` (sources in order):
2. → `configs/*.conf` (base configs)
3. → `configs/custom/*.conf` (overrides)
4. → `configs/plugins/*.conf` (plugin settings)

Custom configs override base configs due to source order.

### State Management

All stateful scripts use:
- **State files**: `~/.cache/hypr/` (ephemeral state)
- **PID files**: `/tmp/` (process tracking)
- **Logs**: `/tmp/` (debugging, auto-rotated)
- **Backups**: Timestamped with automatic cleanup (keep last N)

### Event-Driven Architecture

1. **Hyprland events** → systemd services (`monitor-hotplug`, `lid-handler`)
2. **Monitor changes** → `multi-monitor-manager.sh auto` → AGS/hyperpaper reload
3. **Workspace changes** → state capture → restore on reconnect

### Error Handling

Scripts use color-coded logging:
- `log()`: Green - normal operations
- `warn()`: Yellow - warnings
- `error()`: Red - errors

All long-running scripts log to `/tmp/` with timestamps for debugging.

## AGS Widgets Migration Status (Upstream)

This section tracks widgets and elements from upstream (AymanLyesri) that are commented out, disabled, or pending migration to GTK4/AGS 3.0.

### Widgets Completely Commented (in `app.ts`)

| Widget | File | Status | Notes |
|--------|------|--------|-------|
| **Progress** | `widgets/Progress.tsx` | Comentado | Loading indicator widget |
| **MediaPopups** | N/A | Eliminado | File deleted, import commented |
| **SettingsWidget** | `widgets/SettingsWidget.tsx` | Comentado | Settings panel |
| **OSD** | `widgets/OSD.tsx` | Comentado | On-Screen Display (volume, brightness) |
| **ScreenShot** | `widgets/ScreenShot.tsx` | 100% Comentado | Screenshot preview widget - entire file is commented |

### Widgets with Internal Issues

| Widget | File | Issue | Priority |
|--------|------|-------|----------|
| **Brightness** | `widgets/bar/components/Utilities.tsx` | Screen flickers when adjusting, brightness not applied correctly | Alta |
| **Keyboard Brightness** | `widgets/bar/components/Utilities.tsx` | Keyboard brightness keys not working | Alta |
| **FileChooser** | `widgets/FileChooser.tsx` | File deleted but still imported in UserPanel.tsx | Alta |
| **WallpaperSwitcher** | `widgets/WallpaperSwitcher.tsx` | FileChooserDialog section commented (~30 lines) | Media |
| **ImageDialog** | `widgets/leftPanel/components/ImageDialog.tsx` | `openProgress()` commented | Baja |
| **UserPanel** | `widgets/UserPanel.tsx` | Section marked as "WIP" | Baja |

### Settings Disabled by Default

```typescript
// In constants/settings.constants.ts
rightPanel: {
  visibility: false,  // Right panel hidden by default
},
chatBot: {
  visibility: false,  // ChatBot hidden by default
}
```

### Broken Imports/References

| Missing File | Referenced In | Impact |
|--------------|---------------|--------|
| `FileChooser.tsx` | `UserPanel.tsx` line 16 | Import will fail |
| `MediaPopups.tsx` | `app.ts` line 56 | Commented, no impact |

### Migration Priority

**High Priority (broken functionality):**
1. Brightness widget - flickering and keys not working
2. FileChooser - broken import in UserPanel

**Medium Priority (disabled widgets):**
3. ScreenShot - completely commented
4. OSD - commented
5. SettingsWidget - commented

**Low Priority (minor issues):**
6. WallpaperSwitcher - FileChooser section
7. Progress - loading bars commented
8. UserPanel WIP section
9. MangaViewer - needs architectural improvements (see below)

### File Manager Selector TODO

Add a self-service file manager selector in Settings panel:

**Requirements:**
1. Add dropdown in Settings to choose file manager (Nautilus, Dolphin, Thunar, Nemo, PCManFM)
2. Auto-detect installed file managers
3. Option to install missing file manager (via pacman/yay)
4. Update `app.constants.ts` and `CustomScripts.tsx` dynamically
5. Store preference in settings.json

**Files to modify:**
- `constants/app.constants.ts` - make file manager configurable
- `widgets/leftPanel/components/SettingsWidget.tsx` - add selector UI
- `widgets/leftPanel/components/CustomScripts.tsx` - use configured file manager

### MangaViewer TODO

The MangaViewer widget needs significant improvements:

**Current Issues:**
- Downloads all pages locally (consumes disk space and memory)
- No cache size limit or automatic cleanup
- Can cause system freeze due to memory consumption
- Multiple concurrent downloads without proper throttling

**Proposed Improvements:**
1. Stream images directly instead of downloading to disk
2. Implement LRU cache with configurable size limit
3. Add automatic cleanup of old cached pages
4. Lazy load with virtualized list (only render visible pages)
5. Add download progress indicator
6. Consider using a dedicated manga reader app integration instead

### Notes

- Last updated: 2026-01-03
- All widgets need GTK4 compatibility review
- Some widgets may depend on deprecated AGS 2.x APIs

---

## Home Directory Reorganization

**Status:** ✅ **COMPLETADO**
**Fecha completado:** 2026-01-04
**Fecha diagnóstico original:** 2026-01-03

### Resumen de Resultados

| Métrica | Antes | Después |
|---------|-------|---------|
| Disco usado | 348GB | 321GB |
| Disco libre | 582GB | 609GB |
| Cache `~/.cache/` | 54GB | 12GB |
| **Espacio recuperado** | - | **+27GB** |

### Acciones Completadas

#### Fase 1: Limpieza de Caches ✅
- `~/.cache/davinci-resolve-install/` (24GB) - **BORRADO**
- `~/.cache/JetBrains/` versiones antiguas (~17GB) - **BORRADO**
- `pip cache purge` (673MB) - **BORRADO**
- `npm cache clean` (3.7GB) - **BORRADO**

#### Fase 2: Mover Archivos Personales ✅
- `COMO_USAR_*.md` → `~/Documents/guides/`
- `paquetes_instalados.txt` → `~/Documents/backups/`
- `fix-vlc-mime.sh`, `setup-teams-profiles.sh` → `~/.local/bin/`
- `postman.log`, `Untitled.blend` - **BORRADOS**

#### Fase 3: Consolidar Configs ✅
- **Hallazgo:** Las carpetas `~/wofi/`, `~/mako/`, `~/swaylock/` están trackeadas por git (upstream)
- **Decisión:** Mantener para compatibilidad con upstream (no están en uso activo)

#### Fase 4: Limpiar Carpetas Obsoletas ✅
- `~/dotfiles_backup_20250320/` (619MB) - **BORRADO**
- Carpetas legacy (waybar, wofi, etc.) - **MANTENIDAS** (trackeadas por git)

#### Fase 5: Actualizar .gitignore ✅
- Agregada documentación explicando la estrategia de ignore

### Inventario Verificado (2026-01-04)

#### Archivos Sueltos Confirmados en `~/`

| Archivo | Tamaño | Origen | Acción |
|---------|--------|--------|--------|
| `cheatsheet.md` | 4KB | **Upstream (JaKooLit)** | Dejar (parte del repo) |
| `COMO_USAR_HISTORIAL_PORTAPAPELES.md` | 4.4KB | Personal | Mover a `~/Documents/guides/` |
| `COMO_USAR_WINDSURF.md` | 1.4KB | Personal | Mover a `~/Documents/guides/` |
| `paquetes_instalados.txt` | 35KB | Personal | Mover a `~/Documents/backups/` |
| `fix-vlc-mime.sh` | 507B | Personal | Mover a `~/.local/bin/` |
| `setup-teams-profiles.sh` | 7KB | Personal | Mover a `~/.local/bin/` |
| `postman.log` | 13KB | Basura | ❌ Borrar |
| `Untitled.blend` | 599KB | Basura | ❌ Borrar |
| `README.md` | 7KB | Upstream | Dejar (parte del repo) |
| `CHANGELOG.md` | 1.8KB | Upstream | Dejar (parte del repo) |
| `quickstart.sh` | 19KB | Upstream | Dejar (parte del repo) |
| `hyprland.conf` | 2.9KB | Upstream | Dejar (parte del repo) |
| `hyprpaper.conf` | 162B | Upstream | Dejar (parte del repo) |

#### Carpetas Duplicadas/Obsoletas Confirmadas

| Carpeta | Tamaño | Acción |
|---------|--------|--------|
| `~/waybar/` | 24KB | ❌ Borrar (ya usas AGS) |
| `~/waybarBackUp/` | 60KB | ❌ Borrar |
| `~/wofi/` | 24KB | Comparar con `~/.config/wofi/` |
| `~/wofifull/` | 16KB | ❌ Borrar |
| `~/mako/` | 568KB | Comparar con `~/.config/mako/` |
| `~/swaylock/` | 4KB | Comparar con `~/.config/swaylock/` |
| `~/themes/` | 16KB | Mover a `~/.themes/` |
| `~/scripts/` | 96KB | Consolidar con `~/.config/hypr/scripts/` |
| `~/configs/` | 36KB | Verificar duplicados con `~/.config/hypr/configs/` |
| `~/dotfiles_backup_20250320/` | 619MB | Revisar y borrar |

#### Caches Verificados

| Cache | Tamaño | Acción |
|-------|--------|--------|
| `~/.cache/davinci-resolve-install/` | **24GB** | ✅ Borrar (instalador ya usado) |
| `~/.cache/JetBrains/` | **20GB** | ⚠️ Limpiar caches viejos |

**Nota:** `~/wallpapers/` NO existe (ya está correcto)

### Problema Principal

El HOME completo (`~`) es el repositorio de ArchEclipse. Esto causa:
- Mezcla de archivos personales con la rice
- Archivos de config duplicados (en `~/` y `~/.config/`)
- Dificultad para sincronizar con upstream
- Confusión sobre qué archivos son de la rice vs personales

### Diagnóstico de Espacio

| Carpeta | Tamaño | Notas |
|---------|--------|-------|
| `~/.local` | 116GB | Steam 91GB, JetBrains 18GB |
| `~/.cache` | 54GB | DaVinci installer 24GB, JetBrains 20GB |
| `~/Downloads` | 42GB | Limpieza pendiente |
| `~/.config` | 16GB | Normal |
| `~/.npm` | 3.7GB | Cache de npm |
| `~/.gradle` | 2.7GB | Cache de Android |

### Espacio Recuperable (~45GB+)

| Carpeta | Tamaño | Acción |
|---------|--------|--------|
| `~/.cache/davinci-resolve-install/` | 24GB | ✅ Borrar (es solo el instalador) |
| `~/.cache/JetBrains/` | 20GB | ⚠️ Borrar parcialmente (caches viejos) |
| `~/dotfiles_backup_20250320/` | 619MB | ✅ Revisar y borrar si no se necesita |
| `~/waybarBackUp/` | ? | ✅ Borrar (ya no se usa waybar) |
| `~/.cache/mozilla/` | 4.3GB | ⚠️ Limpiar caches viejos |
| `~/.cache/Google/` | 3.3GB | ⚠️ Limpiar caches viejos |

### Archivos Sueltos en Home (no deberían estar ahí)

**Archivos del repo ArchEclipse:**
- `README.md`, `LICENSE`, `CHANGELOG.md`
- `hyprland.conf`, `hyprpaper.conf`
- `quickstart.sh`

**Archivos personales que necesitan moverse:**
- `COMO_USAR_HISTORIAL_PORTAPAPELES.md` - mover a `~/Documents/guides/`
- `COMO_USAR_WINDSURF.md` - mover a `~/Documents/guides/`
- `paquetes_instalados.txt` - mover a `~/Documents/backups/`
- `fix-vlc-mime.sh` - mover a `~/.local/bin/`
- `setup-teams-profiles.sh` - mover a `~/.local/bin/`

**Archivos basura a borrar:**
- `postman.log` - log viejo de Postman
- `Untitled.blend` - proyecto Blender vacío/sin usar

**Nota:** `cheatsheet.md` es de upstream (JaKooLit), NO es personal - dejarlo

### Carpetas en `~/` - Análisis Completo (Verificado 2026-01-04)

#### Carpetas Trackeadas por Git (NO BORRAR - parte del repo upstream)

| Carpeta | Archivos en Git | En Uso | Notas |
|---------|-----------------|--------|-------|
| `~/wofi/` | 5 | ❌ (usa AGS) | Config wofi - mantener por upstream |
| `~/wofifull/` | 4 | ❌ | Variante wofi - mantener por upstream |
| `~/mako/` | 6+ | ❌ | Config notificaciones - mantener por upstream |
| `~/swaylock/` | 1 | ❌ (usa hyprlock) | Config lock - mantener por upstream |
| `~/waybar/` | 5 | ❌ (usa AGS) | Config waybar - mantener por upstream |
| `~/waybarBackUp/` | 11 | ❌ | Backup waybar - mantener por upstream |
| `~/themes/` | 4 | ✅ | Temas Catppuccin - mantener |
| `~/scripts/` | 24 | ✅ | Scripts del rice - mantener |
| `~/configs/` | 6 | ✅ | Configs base - mantener |

**¿Por qué no borrar?** Estas carpetas están trackeadas por git. Borrarlas causaría:
- Git las marcaría como "deleted"
- Conflictos al sincronizar con upstream
- Pérdida de compatibilidad con la rice original

#### Carpetas NO en Git (seguras de borrar)

| Carpeta | Tamaño | Contenido | Acción |
|---------|--------|-----------|--------|
| `~/dotfiles_backup_20250320/` | 619MB | Backup de .config de marzo 2025 | ✅ **BORRAR** |

#### Herramientas Actuales vs Configs del Repo

| Función | Config en Repo | Herramienta Actual | Estado |
|---------|----------------|-------------------|--------|
| Lanzador | `~/wofi/`, `~/wofifull/` | **AGS** app-launcher | AGS activo |
| Notificaciones | `~/mako/` | **AGS** | AGS activo |
| Bloqueo pantalla | `~/swaylock/` | **hyprlock** | hyprlock instalado |
| Barra de estado | `~/waybar/` | **AGS** | AGS activo |

**Conclusión:** Las configs antiguas (wofi, mako, swaylock, waybar) se mantienen por compatibilidad con upstream pero NO están en uso. El sistema usa AGS y hyprlock.

### Plan de Reorganización (5 Fases)

#### Fase 1: Limpieza de Caches (+40GB)
```bash
# Borrar instalador de DaVinci (ya instalado)
rm -rf ~/.cache/davinci-resolve-install/

# Limpiar caches de JetBrains (mantener solo proyectos activos)
# Revisar manualmente: ~/.cache/JetBrains/

# Limpiar cache de pip
pip cache purge

# Limpiar cache de npm
npm cache clean --force
```

#### Fase 2: Mover Archivos Personales
```bash
# Crear estructura (si no existe)
mkdir -p ~/Documents/guides
mkdir -p ~/Documents/backups
mkdir -p ~/.local/bin

# Mover guías personales (NO cheatsheet.md - ese es de upstream)
mv ~/COMO_USAR_HISTORIAL_PORTAPAPELES.md ~/Documents/guides/
mv ~/COMO_USAR_WINDSURF.md ~/Documents/guides/

# Mover backups
mv ~/paquetes_instalados.txt ~/Documents/backups/

# Mover scripts personales
mv ~/fix-vlc-mime.sh ~/.local/bin/
mv ~/setup-teams-profiles.sh ~/.local/bin/

# Limpiar basura
rm ~/postman.log
rm ~/Untitled.blend
```

#### Fase 3: Consolidar Configs
```bash
# Verificar qué configs en ~/ son diferentes de ~/.config/
diff -r ~/wofi ~/.config/wofi 2>/dev/null
diff -r ~/mako ~/.config/mako 2>/dev/null

# Si son iguales o ~/.config/ es más reciente, borrar de ~/
# Si ~/ tiene cambios importantes, mover a ~/.config/
```

#### Fase 4: Limpiar Carpetas Obsoletas
```bash
# Waybar ya no se usa (reemplazado por AGS)
rm -rf ~/waybar ~/waybarBackUp

# Backups viejos (verificar primero)
ls -la ~/dotfiles_backup_20250320/
# Si no se necesita: rm -rf ~/dotfiles_backup_20250320/
```

#### Fase 5: Actualizar .gitignore
Agregar al `.gitignore` del repo:
```gitignore
# Personal files (not part of rice)
Documents/
Downloads/
Pictures/
Music/
Videos/
Desktop/
Games/
dev_proyects/
.cache/
.local/
.mozilla/
.steam/
*.log
*.blend
```

### Consideraciones Importantes

1. **NO mover `~/.config/hypr/`** - Es el corazón de la rice
2. **NO mover `~/.config/ags/`** - Barra de estado
3. **Verificar symlinks** antes de mover carpetas
4. **Hacer backup** antes de borrar cualquier cosa
5. **Probar** después de cada fase que la rice siga funcionando

### Comandos de Verificación

```bash
# Ver qué archivos están siendo trackeados por git en ~/
git -C ~ ls-files | head -50

# Ver archivos ignorados
git -C ~ status --ignored

# Ver tamaño de carpetas
du -sh ~/*/ ~/.*/  2>/dev/null | sort -hr | head -20

# Verificar symlinks
find ~ -maxdepth 2 -type l -ls 2>/dev/null
```

### Resultado Esperado

Después de la reorganización:
- **Home limpio** con solo carpetas estándar XDG (Documents, Downloads, etc.)
- **+40GB recuperados** de caches innecesarios
- **Configs consolidadas** en `~/.config/`
- **Scripts organizados** en `~/.local/bin/` o `~/.config/hypr/scripts/`
- **Rice intacta** y funcionando
- **Git repo más limpio** con .gitignore apropiado

---

## Git History Rebase (2026-01-04)

**Status:** ✅ **COMPLETADO**
**Fecha:** 2026-01-04

### Problema Original

El historial de git del fork había divergido completamente del upstream debido a:
1. Commits con `Co-Authored-By: Claude` que fueron reescritos
2. Múltiples integraciones de upstream que crearon historiales paralelos
3. 233 commits totales mezclados entre upstream y fork

**Síntomas:**
- `git merge-base HEAD upstream/master` no encontraba ancestro común
- 868 commits "detrás" de upstream (falso - era divergencia)
- Imposible hacer `git pull upstream master` limpiamente

### Solución Aplicada: Rebase Limpio

#### Paso 1: Crear rama desde upstream/master
```bash
git checkout -b clean-rebase upstream/master
```

#### Paso 2: Identificar archivos únicos del fork
Se identificaron los archivos que son ÚNICOS del fork (no existen en upstream):
- Documentación: `CLAUDE.md`, `CLAUDE_PASTE_SOLUTION.md`, `CLIPBOARD-MONITOR-README.md`, etc.
- Scripts: `monitor-hotplug.sh`, `lid-handler.sh`, `multi-monitor-manager.sh`, etc.
- Configs: `exec.conf` (con fix LD_PRELOAD), `multi-monitor-keybinds.conf`

#### Paso 3: Copiar archivos únicos
```bash
git checkout backup-before-rebase -- .config/hypr/CLAUDE.md
git checkout backup-before-rebase -- .config/hypr/scripts/monitor-hotplug.sh
# ... etc
```

#### Paso 4: Commit con todas las mejoras del fork
```bash
git commit -m "feat: add multi-monitor support, clipboard management, and documentation"
```

#### Paso 5: Reemplazar master
```bash
git branch -m master old-master
git branch -m clean-rebase master
git push --force origin master
```

### Resultado

| Métrica | Antes | Después |
|---------|-------|---------|
| Commits totales | 233 (mezclados) | Lineal desde upstream |
| Commits detrás de upstream | 868 (divergente) | **0** |
| Commits adelante de upstream | N/A | **2** |
| Historial | Divergente | **Lineal y limpio** |

### Archivos Preservados en el Rebase

#### Documentación (8 archivos)
- `.config/hypr/CLAUDE.md` - Documentación principal del proyecto
- `.config/hypr/CLAUDE_PASTE_SOLUTION.md` - Solución para paste en Claude Code
- `.config/hypr/CLIPBOARD-MONITOR-README.md` - Documentación del clipboard monitor
- `.config/hypr/CHANGELOG.md` - Historial de cambios
- `.config/hypr/COMANDOS-UPDATE.md` - Guía de comandos de actualización
- `.config/hypr/.claude/agents/*.md` - Configuraciones de agentes

#### Scripts de Multi-Monitor (5 archivos)
- `monitor-hotplug.sh` - Detección automática de monitores
- `lid-handler.sh` - Manejo de tapa del laptop
- `multi-monitor-manager.sh` - Gestión central de monitores
- `workspace-state-manager.sh` - Preservación de estado (KVM)
- `multi-monitor-keybinds.conf` - Atajos de teclado para monitores

#### Scripts de Clipboard (4 archivos)
- `start-clipboard-monitor.sh` - Lanzador singleton
- `clipboard-monitor.sh` - Lógica de notificaciones
- `check-clipboard-monitor.sh` - Diagnóstico de salud

#### Scripts Mejorados
- `UPDATE.sh` - Script de actualización (+1000 líneas sobre upstream)
- `bar.sh` - Compatibilidad AGS 3.0
- `exec.conf` - Fix LD_PRELOAD para gtk4-layer-shell

### Backups Disponibles

Si necesitas recuperar algo del historial anterior:
- `old-master` - Rama con el historial anterior al rebase
- `backup-before-rebase` - Backup completo antes del rebase

```bash
# Ver commits del historial anterior
git log old-master --oneline -20

# Recuperar un archivo específico del historial anterior
git checkout old-master -- path/to/file
```

### Sincronización Futura

Ahora que el historial está limpio, sincronizar con upstream es simple:

```bash
git fetch upstream
git merge upstream/master  # Debería ser fast-forward o merge limpio
git push origin master
```

---

## Session Log: 2026-01-04

### Acciones Realizadas en Esta Sesión

1. **Home Directory Reorganization (Fases 1-5)**
   - Limpieza de caches: +27GB recuperados
   - Reorganización de archivos personales
   - Documentación de carpetas trackeadas vs personales
   - Actualización de .gitignore

2. **Git History Rebase**
   - Identificación de archivos únicos del fork
   - Creación de rama limpia desde upstream/master
   - Preservación de todas las mejoras del fork
   - Force push con historial lineal

3. **GitHub Issue #190**
   - Creada propuesta para reorganización de home directory en upstream
   - Preguntas sobre carpetas legacy (waybar, wofi, mako, swaylock)
   - Propuesta de script `reorganize-home.sh`

### Commits Creados
```
8f70b4b chore: add local config backups and experimental scripts
6d37954 feat: add multi-monitor support, clipboard management, and documentation
```

### Estado Final del Fork
- Historial: Lineal, basado en upstream/master
- Commits adelante: 2 (mejoras del fork)
- Commits detrás: 0 (totalmente sincronizado)
- AGS: Compila correctamente
- Servicios: Todos activos y funcionando
