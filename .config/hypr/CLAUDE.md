# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## User Preferences

- **Language**: Always communicate with the user in Spanish (Español). All responses, explanations, and questions must be in Spanish.

## Repository Context

This is a fork of [AymanLyesri/ArchEclipse](https://github.com/AymanLyesri/ArchEclipse), a comprehensive Hyprland rice configuration for Arch Linux. The fork adds extensive multi-monitor support, workspace state preservation for KVM switches, and clipboard management enhancements.

**Your Fork:** [mrvictor22/ArchEclipse](https://github.com/mrvictor22/ArchEclipse)

## Configuration Architecture

### Core Structure

- **`hyprland.conf`**: Main entry point that sources all configuration files
  - Sources `configs/*` for base configuration
  - Sources `configs/custom/*` for user overrides
  - Sources `configs/plugins/*` for plugin settings

### Configuration Layers

1. **Base configs** (`configs/*.conf`): Default settings that can be overridden
2. **Custom configs** (`configs/custom/*.conf`): User-specific overrides (take precedence)
3. **Generated configs**: Auto-generated by scripts (e.g., `monitors.conf`)

### Key Configuration Files

- `configs/exec.conf`: Startup commands and autostart applications
- `configs/keybinds.conf`: Primary keyboard shortcuts
- `configs/multi-monitor-keybinds.conf`: Multi-monitor specific keybinds
- `configs/monitors.conf`: Auto-generated monitor configuration
- `configs/general.conf`: Core Hyprland settings

## Multi-Monitor System

### Core Scripts

| Script | Purpose |
|--------|---------|
| `multi-monitor-manager.sh` | Central management (`auto`, `status`, `redistribute`, `setup`, `lid`) |
| `monitor-hotplug.sh` | Hotplug detection daemon (systemd service) |
| `lid-handler.sh` | Laptop lid events (systemd service) |
| `monitor-setup.sh` | Quick presets (`auto`, `laptop-only`, `external-only`, `dual-extend`) |

### Multi-Monitor Flow

1. Monitor connect/disconnect detected (2s polling)
2. `multi-monitor-manager.sh auto` reconfigures monitors
3. AGS bars restart with `--gtk 3` flag
4. Hyperpaper wallpapers reload

### AGS 3.0 Compatibility (Critical)

AGS requires explicit GTK version and proper library loading:

```bash
LD_PRELOAD=/usr/lib/libgtk4-layer-shell.so GDK_BACKEND=wayland ags run --gtk 3 --log-file /tmp/ags.log
```

**Why LD_PRELOAD**: Forces gtk4-layer-shell to load before libwayland, enabling layer shell support.

**Symptoms without it**: Bars don't appear, logs show "layer shell not supported".

## Workspace State Preservation (KVM Support)

**Script**: `workspace-state-manager.sh` (`save`, `restore`, `show`, `current`, `clear`)

- State stored in: `~/.cache/hypr/workspace-states/current-state.json`
- Automatic save on disconnect, restore on reconnect (if < 10 min old)

## Clipboard Monitor System

| Script | Purpose |
|--------|---------|
| `start-clipboard-monitor.sh` | Singleton launcher (use this always) |
| `clipboard-monitor.sh` | Core notification logic |
| `check-clipboard-monitor.sh` | Health check and diagnostics |

**Important**: Must run as singleton. Multiple instances cause duplicate notifications.

## Screenshot System for Claude Code

Screenshots save to `~/Pictures/Screenshots/latest.png` (overwritten each time).

**Usage**: `Read ~/Pictures/Screenshots/latest.png`

## Syncing with Upstream

### IMPORTANTE: Cherry-pick selectivo, NO merge

Este fork tiene modificaciones propias. **NUNCA hacer merge ciego de upstream**.

```bash
# 1. Ver qué hay nuevo
git fetch upstream
git log --oneline HEAD..upstream/master

# 2. Revisar cada commit ANTES de decidir
git show <hash> --stat

# 3. Verificar si toca archivos del fork (ver docs/FORK-MODIFICATIONS.md)

# 4. Solo cherry-pick commits seguros
git cherry-pick <hash>
```

### Archivos protegidos del fork

Ver `docs/FORK-MODIFICATIONS.md` para lista completa. Principales:
- `.config/ags/constants/app.constants.ts` (File Manager Selector)
- `.config/ags/widgets/leftPanel/components/SettingsWidget.tsx` (File Manager Selector UI)
- `.config/ags/scripts/search-booru.py` (null safety)
- `configs/exec.conf` (LD_PRELOAD fix)

**Nota**: El fix de `get_connector()` fue incorporado por Ayman en `utils/monitor.ts` (commit 1c8f1fb7)

### Commit Rules

**NEVER include in commits:**
- `Co-Authored-By: Claude`
- `Generated with [Claude Code]`
- Any AI attribution markers

## Development Commands

### Quick Reference

```bash
# Monitor management
~/.config/hypr/scripts/multi-monitor-manager.sh auto|status

# AGS
~/.config/hypr/scripts/bar.sh restart
ags toggle user-panel-eDP-1

# Clipboard
~/.config/hypr/scripts/check-clipboard-monitor.sh

# Hyprland
hyprctl monitors -j
hyprctl clients
hyprctl reload
```

### Systemd Services

```bash
systemctl --user status hyprland-monitor-hotplug.service
systemctl --user status hyprland-lid-handler.service
```

## Key Implementation Details

### Script Variables

- `$scriptsDir`: `$HOME/.config/hypr/scripts`
- `$hyprDir`: `$HOME/.config/hypr`

### Dependencies

`jq`, `hyprctl`, `wl-paste`, `ags` (v3.0+), `hyperpaper`, `notify-send`

### Files to Preserve When Syncing

- `configs/custom/*`: User customizations
- `configs/monitors.conf`: Auto-generated
- `.gitignore`: Protects local files

## Documentation (Extended)

Detailed documentation available in `docs/`:

| File | Content |
|------|---------|
| `docs/FORK-MODIFICATIONS.md` | **Lista de archivos modificados del fork** (revisar antes de sync) |
| `docs/BUGS-FIXED.md` | Detailed bug fixes with code examples |
| `docs/HOME-REORGANIZATION.md` | Home directory cleanup (2026-01-04) |
| `docs/GIT-REBASE-2026-01-04.md` | Git history cleanup procedure |
| `docs/AGS-MIGRATION-STATUS.md` | AGS widget migration tracking |
